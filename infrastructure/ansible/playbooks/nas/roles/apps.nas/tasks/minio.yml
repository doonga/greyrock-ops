---
- name: setup minio directory
  ansible.builtin.file:
    path: /speedy/minio
    state: directory
    group: "1000"
    owner: "1000"
    mode: "0600"

- name: run minio
  containers.podman.podman_container:
    name: minio
    image: "quay.io/minio/minio:RELEASE.2023-05-18T00-05-36Z@sha256:d03ab478cd6652a3dd7f043395b969d8fa58eac8b83ba052405869229e62f2a8"
    state: started
    network: host
    command:
      - "server"
      - "/data"
      - "--console-address"
      - ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    env:
      TZ: ${TZ}
      MINIO_ROOT_USER: "{{ minio.root_user }}"
      MINIO_ROOT_PASSWORD: "{{ minio.root_password }}"
      MINIO_UPDATE: "off"
      MINIO_PROMETHEUS_URL: http://prometheus.{{ external_domain }}
      MINIO_PROMETHEUS_JOB_ID: minio
      MINIO_PROMETHEUS_AUTH_TYPE: "public"
      MINIO_BROWSER_REDIRECT_URL: "http://s3.{{ internal_domain }}:9001"
      MINIO_SERVER_URL: "http://s3.{{ internal_domain }}:9000"
    generate_systemd:
      path: "/home/{{ ansible_user }}/.config/systemd/user"
      restart_policy: always
      time: 120
      names: true
      container_prefix: ansible
    volume:
      - "/speedy/minio:/data:z"
  become: false

- name: enable podman-systemd | minio
  ansible.builtin.systemd:
    name: ansible-minio
    enabled: true
    scope: user
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ ansible_user_uid }}"
  become: false
  remote_user: todd
