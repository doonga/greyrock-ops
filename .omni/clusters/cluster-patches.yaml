# Cluster
machine:
  network:
    # Disable search domain everywhere
    disableSearchDomain: true

    # Force nameserver
    nameservers:
      - 10.46.0.4

  # Configure NTP
  time:
    disabled: false
    servers:
      - 10.1.7.2
      - 10.1.7.3
      - 10.1.7.4
      - 10.1.7.5

  # Custom sysctls
  sysctls:
    fs.inotify.max_queued_events: "65536"
    fs.inotify.max_user_instances: "8192"
    fs.inotify.max_user_watches: "524288"
    net.core.rmem_max: "2500000"
    net.core.wmem_max: "2500000"

  # Kubelet configuration
  kubelet:
    defaultRuntimeSeccompProfileEnabled: true
    extraArgs:
      feature-gates: GracefulNodeShutdown=true,NewVolumeManagerReconstruction=false
      rotate-server-certificates: "true"
    extraConfig:
      maxPods: 150
    nodeIP:
      validSubnets:
        - 10.1.1.0/24

    # Mounts for local storage
    extraMounts:
      - destination: /var/mnt/sata
        type: bind
        source: /var/mnt/sata
        options:
          - rbind
          - rshared
          - rw

  files:
    # Configure containerd
    - op: create
      path: /etc/cri/conf.d/20-customization.part
      content: |-
        [plugins."io.containerd.grpc.v1.cri"]
          enable_unprivileged_ports = true
          enable_unprivileged_icmp = true
        [plugins."io.containerd.grpc.v1.cri".containerd]
          discard_unpacked_layers = false
        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
          discard_unpacked_layers = false
      permissions: 0

    # Configure nfs mount options
    - op: overwrite
      path: /etc/nfsmount.conf
      permissions: 0o644
      content: |
        [ NFSMount_Global_Options ]
        nfsvers=4.2
        hard=True
        noatime=True
        nodiratime=True
        rsize=131072
        wsize=131072
        nconnect=8

cluster:
  network:
    # Disable CNI for Cilium
    cni:
      name: none
  # Disable kubeproxy
  proxy:
    disabled: true
