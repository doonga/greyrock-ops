kind: Cluster
name: utility
kubernetes:
  # renovate: depName=kubernetes/kubernetes datasource=github-releases extractVersion=^v(?<version>.*)$
  version: v1.29.4
talos:
  # renovate: depName=ghcr.io/siderolabs/installer datasource=docker extractVersion=^(?<version>.*)$
  version: v1.7.0
features:
  diskEncryption: true
  backupConfiguration:
    interval: 1h0m0s
patches:
  - idOverride: 200-utility
    inline:
      cluster:
        network:
          cni:
            name: none
        proxy:
          disabled: true
      machine:
        files:
          - content: |-
              [plugins."io.containerd.grpc.v1.cri"]
                enable_unprivileged_ports = true
                enable_unprivileged_icmp = true
              [plugins."io.containerd.grpc.v1.cri".containerd]
                discard_unpacked_layers = false
              [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
                discard_unpacked_layers = false
            op: create
            path: /etc/cri/conf.d/20-customization.part
            permissions: 0
          - content: |
              [ NFSMount_Global_Options ]
              nfsvers=4.2
              hard=True
              noatime=True
              nodiratime=True
              rsize=131072
              wsize=131072
              nconnect=8
            op: overwrite
            path: /etc/nfsmount.conf
            permissions: 420
        kubelet:
          defaultRuntimeSeccompProfileEnabled: true
          extraArgs:
            feature-gates: GracefulNodeShutdown=true,NewVolumeManagerReconstruction=false
            rotate-server-certificates: "true"
          extraConfig:
            maxPods: 150
          extraMounts:
            - destination: /var/mnt/sata
              options:
                - rbind
                - rshared
                - rw
              source: /var/mnt/sata
              type: bind
          nodeIP:
            validSubnets:
              - 10.1.1.0/24
        network:
          disableSearchDomain: true
          nameservers:
            - 10.46.0.4
        sysctls:
          fs.inotify.max_queued_events: "65536"
          fs.inotify.max_user_instances: "8192"
          fs.inotify.max_user_watches: "524288"
          net.core.rmem_max: "2500000"
          net.core.wmem_max: "2500000"
        time:
          disabled: false
          servers:
            - 10.1.7.2
            - 10.1.7.3
            - 10.1.7.4
            - 10.1.7.5
---
kind: ControlPlane
machines:
  - 1ead03ec-069e-75af-657e-48210b3ed814
  - 5d35ad44-a5cb-684f-f351-48210b3ed802
  - dfd3e0cb-8ce4-3109-c087-48210b3edbda
patches:
  - idOverride: 400-utility-control-planes
    inline:
      cluster:
        allowSchedulingOnControlPlanes: true
        apiServer:
          admissionControl:
            - configuration:
                exemptions:
                  namespaces:
                    - monitoring
                    - openebs
                    - security
                    - system
                kind: PodSecurityConfiguration
              name: PodSecurity
          certSANs:
            - 10.1.1.7
            - 127.0.0.1
          disablePodSecurityPolicy: true
          extraArgs:
            bind-address: 0.0.0.0
        controllerManager:
          extraArgs:
            bind-address: 0.0.0.0
        etcd:
          advertisedSubnets:
            - 10.1.1.0/24
          extraArgs:
            listen-metrics-urls: http://0.0.0.0:2381
        scheduler:
          extraArgs:
            bind-address: 0.0.0.0
      machine:
        features:
          kubePrism:
            enabled: true
            port: 7445
---
kind: Workers
---
kind: Machine
name: 1ead03ec-069e-75af-657e-48210b3ed814
install:
  disk: /dev/sda
patches:
  - idOverride: 400-cm-1ead03ec-069e-75af-657e-48210b3ed814
    inline:
      machine:
        disks:
          - device: /dev/disk/by-id/nvme-WDC_WDS500G2B0C-00PXH0_21381C806554
            partitions:
              - mountpoint: /var/mnt/sata
        network:
          hostname: k8s4
          interfaces:
            - bond:
                deviceSelectors:
                  - driver: igc
                    hardwareAddr: 48:21:0b:3e:d8:14
                interfaces: []
                mode: active-backup
              dhcp: true
              interface: bond0
              vip:
                ip: 10.1.1.7
---
kind: Machine
name: 5d35ad44-a5cb-684f-f351-48210b3ed802
install:
  disk: /dev/sda
patches:
  - idOverride: 400-cm-5d35ad44-a5cb-684f-f351-48210b3ed802
    inline:
      machine:
        disks:
          - device: /dev/disk/by-id/nvme-WD_Blue_SN570_500GB_22410H804662
            partitions:
              - mountpoint: /var/mnt/sata
        network:
          hostname: k8s6
          interfaces:
            - bond:
                deviceSelectors:
                  - driver: igc
                    hardwareAddr: 48:21:0b:3e:d8:02
                interfaces: []
                mode: active-backup
              dhcp: true
              interface: bond0
              vip:
                ip: 10.1.1.7
---
kind: Machine
name: dfd3e0cb-8ce4-3109-c087-48210b3edbda
install:
  disk: /dev/sda
patches:
  - idOverride: 400-cm-dfd3e0cb-8ce4-3109-c087-48210b3edbda
    inline:
      machine:
        disks:
          - device: /dev/disk/by-id/nvme-WDC_WDS500G2B0C-00PXH0_21381C801327
            partitions:
              - mountpoint: /var/mnt/sata
        network:
          hostname: k8s5
          interfaces:
            - bond:
                deviceSelectors:
                  - driver: igc
                    hardwareAddr: 48:21:0b:3e:db:da
                interfaces: []
                mode: active-backup
              dhcp: true
              interface: bond0
              vip:
                ip: 10.1.1.7
