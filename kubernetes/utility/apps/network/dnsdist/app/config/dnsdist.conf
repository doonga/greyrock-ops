-- udp/tcp dns listening
setLocal("0.0.0.0:53", {})
-- disable security status polling via DNS
setSecurityPollSuffix("")

-- Local Bind
newServer({
  address = "10.46.0.3",
  pool = "bind",
  tcpOnly = true,
  healthCheckMode="lazy",
  checkInterval=1,
  lazyHealthCheckFailedInterval=30,
  rise=2,
  maxCheckFailures=3,
  lazyHealthCheckThreshold=30,
  lazyHealthCheckSampleSize=100,
  lazyHealthCheckMinSampleCount=10,
  lazyHealthCheckMode='TimeoutOnly',
  useClientSubnet = true
})

-- Local Blocky
newServer({
  address = "10.46.0.7",
  pool = "blocky",
  tcpOnly = true,
  healthCheckMode="lazy",
  checkInterval=1,
  lazyHealthCheckFailedInterval=30,
  rise=2,
  maxCheckFailures=3,
  lazyHealthCheckThreshold=30,
  lazyHealthCheckSampleSize=100,
  lazyHealthCheckMinSampleCount=10,
  lazyHealthCheckMode='TimeoutOnly',
  useClientSubnet = true
})
-- Blocky will be given requester IP
setECSSourcePrefixV4(32)

-- Local Unifi Controller
newServer({
  address = "10.1.1.1:53",
  healthCheckMode="lazy",
  checkInterval=1,
  lazyHealthCheckFailedInterval=30,
  rise=2,
  maxCheckFailures=3,
  lazyHealthCheckThreshold=30,
  lazyHealthCheckSampleSize=100,
  lazyHealthCheckMinSampleCount=10,
  lazyHealthCheckMode='TimeoutOnly',
  pool = "udm"
})

-- Enable caching
pc = newPacketCache(10000, {
  maxTTL = 86400,
  minTTL = 0,
  temporaryFailureTTL = 60,
  staleTTL = 60,
  dontAge = false
})
getPool(""):setCache(pc)

-- Request logging, uncomment to log DNS requests/responses to stdout
-- addAction(AllRule(), LogAction("", false, false, true, false, false))
-- addResponseAction(AllRule(), LogResponseAction("", false, true, false, false))

-- Routing rules
addAction("zip", DropAction())                          -- stop processing

addAction('unifi', PoolAction('udm'))
addAction('greyrock.io', PoolAction('udm'))
addAction('greyrock.casa', PoolAction('bind'))
addAction('1.10.in-addr.arpa', PoolAction('udm'))

addAction("10.1.0.0/24", PoolAction("udm"))            -- lan
addAction("10.1.1.0/24", PoolAction("udm"))            -- servers vlan
addAction("10.1.2.0/24", PoolAction("blocky"))         -- trusted vlan
addAction("10.1.3.0/24", PoolAction("blocky"))         -- wireless vlan
addAction("10.1.4.0/23", PoolAction("blocky"))         -- iot vlan
addAction("10.1.6.0/24", PoolAction("udm"))            -- video vlan
addAction("10.1.7.0/24", PoolAction("udm"))            -- ntp vlan
addAction("10.1.8.0/24", PoolAction("udm"))            -- voice vlan
addAction("10.0.11.0/24", PoolAction("blocky"))        -- wg_trusted vlan
