kind: Cluster
name: main
kubernetes:
  # renovate: depName=kubernetes/kubernetes datasource=github-releases extractVersion=^v(?<version>.*)$
  version: v1.29.4
talos:
  # renovate: depName=ghcr.io/siderolabs/installer datasource=docker extractVersion=^(?<version>.*)$
  version: v1.7.0
features:
  diskEncryption: true
  backupConfiguration:
    interval: 1h0m0s
patches:
  - idOverride: 200-main
    inline:
      cluster:
        network:
          cni:
            name: none
        proxy:
          disabled: true
      machine:
        files:
          - content: |-
              [plugins."io.containerd.grpc.v1.cri"]
                enable_unprivileged_ports = true
                enable_unprivileged_icmp = true
              [plugins."io.containerd.grpc.v1.cri".containerd]
                discard_unpacked_layers = false
              [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
                discard_unpacked_layers = false
            op: create
            path: /etc/cri/conf.d/20-customization.part
            permissions: 0
          - content: |
              [ NFSMount_Global_Options ]
              nfsvers=4.2
              hard=True
              noatime=True
              nodiratime=True
              rsize=131072
              wsize=131072
              nconnect=8
            op: overwrite
            path: /etc/nfsmount.conf
            permissions: 420
        kubelet:
          defaultRuntimeSeccompProfileEnabled: true
          extraArgs:
            feature-gates: GracefulNodeShutdown=true,NewVolumeManagerReconstruction=false
            rotate-server-certificates: "true"
          extraConfig:
            maxPods: 150
          extraMounts:
            - destination: /var/mnt/sata
              options:
                - rbind
                - rshared
                - rw
              source: /var/mnt/sata
              type: bind
          nodeIP:
            validSubnets:
              - 10.1.1.0/24
        network:
          disableSearchDomain: true
          nameservers:
            - 10.46.0.4
        sysctls:
          fs.inotify.max_queued_events: "65536"
          fs.inotify.max_user_instances: "8192"
          fs.inotify.max_user_watches: "524288"
          net.core.rmem_max: "2500000"
          net.core.wmem_max: "2500000"
        time:
          disabled: false
          servers:
            - 10.1.7.2
            - 10.1.7.3
            - 10.1.7.4
            - 10.1.7.5
---
kind: ControlPlane
machines:
  - 5de2ceb3-4756-8152-8b59-48210b5a4aef
  - 980ac1a2-5e62-e2f9-6edf-48210b5a45df
  - c3c2fce5-fdb5-ef02-cfa1-48210b5a4fa7
patches:
  - idOverride: 400-main-control-planes
    inline:
      cluster:
        allowSchedulingOnControlPlanes: true
        apiServer:
          admissionControl:
            - configuration:
                exemptions:
                  namespaces:
                    - dev
                    - downloads
                    - home-automation
                    - media
                    - monitoring
                    - network
                    - openebs
                    - rook-ceph
                    - security
                    - system
                kind: PodSecurityConfiguration
              name: PodSecurity
          certSANs:
            - 10.1.1.2
            - main.greyrock.io
            - 127.0.0.1
          disablePodSecurityPolicy: true
          extraArgs:
            bind-address: 0.0.0.0
        controllerManager:
          extraArgs:
            bind-address: 0.0.0.0
        etcd:
          advertisedSubnets:
            - 10.1.1.0/24
          extraArgs:
            listen-metrics-urls: http://0.0.0.0:2381
        scheduler:
          extraArgs:
            bind-address: 0.0.0.0
      machine:
        features:
          kubePrism:
            enabled: true
            port: 7445
---
kind: Workers
---
kind: Machine
name: 5de2ceb3-4756-8152-8b59-48210b5a4aef
install:
  disk: /dev/sda
patches:
  - idOverride: 400-cm-5de2ceb3-4756-8152-8b59-48210b5a4aef
    inline:
      machine:
        disks:
          - device: /dev/disk/by-id/ata-INTEL_SSDSC2BB800G4_BTWL406300TG800RGN
            partitions:
              - mountpoint: /var/mnt/sata
        network:
          hostname: k8s1
          interfaces:
            - bond:
                deviceSelectors:
                  - driver: atlantic
                    hardwareAddr: 00:30:93:12:38:d3
                interfaces: []
                mode: active-backup
              dhcp: true
              interface: bond0
              vip:
                ip: 10.1.1.2
              vlans:
                - dhcp: true
                  dhcpOptions:
                    routeMetric: 4096
                  mtu: 1500
                  routes: []
                  vlanId: 40
            - ignore: true
              interface: enp86s0
systemExtensions:
  - siderolabs/intel-ucode
  - siderolabs/i915-ucode
---
kind: Machine
name: 980ac1a2-5e62-e2f9-6edf-48210b5a45df
install:
  disk: /dev/sda
patches:
  - idOverride: 400-cm-980ac1a2-5e62-e2f9-6edf-48210b5a45df
    inline:
      machine:
        disks:
          - device: /dev/disk/by-id/ata-INTEL_SSDSC2BB800G4_BTWL503001EB800RGN
            partitions:
              - mountpoint: /var/mnt/sata
        network:
          hostname: k8s2
          interfaces:
            - bond:
                deviceSelectors:
                  - driver: atlantic
                    hardwareAddr: 00:30:93:12:38:d6
                interfaces: []
                mode: active-backup
              dhcp: true
              interface: bond0
              vip:
                ip: 10.1.1.2
              vlans:
                - dhcp: true
                  dhcpOptions:
                    routeMetric: 4096
                  mtu: 1500
                  routes: []
                  vlanId: 40
            - ignore: true
              interface: enp86s0
systemExtensions:
  - siderolabs/intel-ucode
  - siderolabs/i915-ucode
---
kind: Machine
name: c3c2fce5-fdb5-ef02-cfa1-48210b5a4fa7
install:
  disk: /dev/sda
patches:
  - idOverride: 400-cm-c3c2fce5-fdb5-ef02-cfa1-48210b5a4fa7
    inline:
      machine:
        disks:
          - device: /dev/disk/by-id/ata-INTEL_SSDSC2BB800G4_BTWL421602AP800RGN
            partitions:
              - mountpoint: /var/mnt/sata
        network:
          hostname: k8s3
          interfaces:
            - bond:
                deviceSelectors:
                  - driver: atlantic
                    hardwareAddr: 00:30:93:12:38:8c
                interfaces: []
                mode: active-backup
              dhcp: true
              interface: bond0
              vip:
                ip: 10.1.1.2
              vlans:
                - dhcp: true
                  dhcpOptions:
                    routeMetric: 4096
                  mtu: 1500
                  routes: []
                  vlanId: 40
            - ignore: true
              interface: enp86s0
systemExtensions:
  - siderolabs/intel-ucode
  - siderolabs/i915-ucode
